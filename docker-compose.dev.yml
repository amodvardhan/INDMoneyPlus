version: '3.8'

services:
  # Infrastructure Services
  postgres:
    image: timescale/timescaledb:latest-pg15
    container_name: portfolio-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-portfolio_superapp}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./seed:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-user}"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - portfolio-network

  redis:
    image: redis:7-alpine
    container_name: portfolio-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - portfolio-network

  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v23.2.11
    container_name: portfolio-redpanda
    command:
      - redpanda
      - start
      - --kafka-addr
      - internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr
      - internal://redpanda:9092,external://localhost:19092
      - --pandaproxy-addr
      - internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr
      - internal://redpanda:8082,external://localhost:18082
      - --schema-registry-addr
      - internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --rpc-addr
      - redpanda:33145
      - --advertise-rpc-addr
      - redpanda:33145
      - --smp
      - '1'
      - --memory
      - 1G
      - --mode dev-container
      - --default-log-level=info
    ports:
      - "${KAFKA_PORT:-19092}:19092"
      - "18081:18081"
      - "18082:18082"
    volumes:
      - redpanda_data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -q 'Healthy' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - portfolio-network

  vector-db-mock:
    image: chromadb/chroma:latest
    container_name: portfolio-vectordb
    ports:
      - "${VECTOR_DB_PORT:-8001}:8000"
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
    volumes:
      - vector_db_data:/chroma/chroma
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - portfolio-network

  # Backend Services
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
      target: dev
    container_name: portfolio-auth-service
    ports:
      - "${AUTH_SERVICE_PORT:-8080}:8080"
      - "${AUTH_SERVICE_DEBUG_PORT:-5678}:5678"
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-user}:${POSTGRES_PASSWORD:-password}@postgres:5432/auth_db
      REDIS_URL: redis://redis:6379/0
      JWT_SECRET: ${JWT_SECRET:-dev-secret-key-change-in-production}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      JWT_ACCESS_TOKEN_EXPIRATION: ${JWT_ACCESS_TOKEN_EXPIRATION:-3600}
      JWT_REFRESH_TOKEN_EXPIRATION: ${JWT_REFRESH_TOKEN_EXPIRATION:-604800}
      SERVICE_NAME: auth-service
      SERVICE_VERSION: 0.1.0
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./services/auth-service:/app
      - /app/.venv
    command: sh -c "poetry lock || true && poetry install --no-interaction --no-ansi --no-root && poetry run uvicorn app.main:app --host 0.0.0.0 --port 8080 --reload --reload-dir /app --log-level ${LOG_LEVEL:-info}"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - portfolio-network

  marketdata-service:
    build:
      context: ./services/marketdata-service
      dockerfile: Dockerfile
      target: dev
    container_name: portfolio-marketdata-service
    ports:
      - "${MARKETDATA_SERVICE_PORT:-8081}:8081"
      - "${MARKETDATA_SERVICE_DEBUG_PORT:-5679}:5678"
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-user}:${POSTGRES_PASSWORD:-password}@postgres:5432/marketdata_db
      REDIS_URL: redis://redis:6379/0
      ADAPTER_TYPE: yahoo_finance
      ALPHAVANTAGE_API_KEY: 692e82d3283fc9.87896037
      TIINGO_API_KEY: 60e621f170f7b87aa9c396f818cbfa481e0ef1c8
      AUTH_SERVICE_URL: http://auth-service:8080
      SERVICE_NAME: marketdata-service
      SERVICE_VERSION: 0.1.0
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./services/marketdata-service:/app
      - /app/.venv
    command: sh -c "poetry lock || true && poetry install --no-interaction --no-ansi --no-root && poetry run uvicorn app.main:app --host 0.0.0.0 --port 8081 --reload --reload-dir /app --log-level ${LOG_LEVEL:-info}"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - portfolio-network

  analytics-service:
    build:
      context: ./services/analytics-service
      dockerfile: Dockerfile
      target: dev
    container_name: portfolio-analytics-service
    ports:
      - "${ANALYTICS_SERVICE_PORT:-8082}:8082"
      - "${ANALYTICS_SERVICE_DEBUG_PORT:-5680}:5678"
    environment:
      SERVICE_NAME: analytics-service
      SERVICE_VERSION: 0.1.0
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./services/analytics-service:/app
      - /app/.venv
    command: sh -c "poetry lock || true && poetry install --no-interaction --no-ansi --no-root && poetry run uvicorn app.main:app --host 0.0.0.0 --port 8082 --reload --reload-dir /app --log-level ${LOG_LEVEL:-info}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - portfolio-network

  aggregator-service:
    build:
      context: ./services/aggregator-service
      dockerfile: Dockerfile
      target: dev
    container_name: portfolio-aggregator-service
    ports:
      - "${AGGREGATOR_SERVICE_PORT:-8083}:8083"
      - "${AGGREGATOR_SERVICE_DEBUG_PORT:-5681}:5678"
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-user}:${POSTGRES_PASSWORD:-password}@postgres:5432/aggregator_db
      SERVICE_NAME: aggregator-service
      SERVICE_VERSION: 0.1.0
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./services/aggregator-service:/app
      - /app/.venv
    command: sh -c "poetry lock || true && poetry install --no-interaction --no-ansi --no-root && poetry run uvicorn app.main:app --host 0.0.0.0 --port 8083 --reload --reload-dir /app --log-level ${LOG_LEVEL:-info}"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - portfolio-network

  agent-orchestrator:
    build:
      context: ./services/agent-orchestrator
      dockerfile: Dockerfile
      target: dev
    container_name: portfolio-agent-orchestrator
    ports:
      - "${AGENT_ORCHESTRATOR_PORT:-8084}:8084"
      - "${AGENT_ORCHESTRATOR_DEBUG_PORT:-5682}:5678"
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-user}:${POSTGRES_PASSWORD:-password}@postgres:5432/agent_orchestrator_db
      VECTOR_DB_TYPE: ${VECTOR_DB_TYPE:-chroma}
      VECTOR_DB_URL: http://vector-db-mock:8000
      PINECONE_API_KEY: ${PINECONE_API_KEY:-}
      PINECONE_INDEX_NAME: ${PINECONE_INDEX_NAME:-agent-memory}
      WEAVIATE_URL: ${WEAVIATE_URL:-}
      LLM_PROVIDER: ${LLM_PROVIDER:-openai}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4}
      TEMPERATURE: ${TEMPERATURE:-0.0}
      MARKETDATA_SERVICE_URL: http://marketdata-service:8081
      ANALYTICS_SERVICE_URL: http://analytics-service:8082
      AGGREGATOR_SERVICE_URL: http://aggregator-service:8083
      ORDER_ORCHESTRATOR_URL: http://order-orchestrator:8086
      AUTH_SERVICE_URL: http://auth-service:8080
      SERVICE_NAME: agent-orchestrator
      SERVICE_VERSION: 0.1.0
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./services/agent-orchestrator:/app
      - /app/.venv
    command: sh -c "poetry lock || true && poetry install --no-interaction --no-ansi --no-root && poetry run uvicorn app.main:app --host 0.0.0.0 --port 8084 --reload --reload-dir /app --log-level ${LOG_LEVEL:-info}"
    depends_on:
      postgres:
        condition: service_healthy
      marketdata-service:
        condition: service_healthy
      analytics-service:
        condition: service_healthy
      aggregator-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - portfolio-network

  notification-service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
      target: dev
    container_name: portfolio-notification-service
    ports:
      - "${NOTIFICATION_SERVICE_PORT:-8085}:8085"
      - "${NOTIFICATION_SERVICE_DEBUG_PORT:-5683}:5678"
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-user}:${POSTGRES_PASSWORD:-password}@postgres:5432/notification_db
      REDIS_URL: redis://redis:6379/1
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      SERVICE_NAME: notification-service
      SERVICE_VERSION: 0.1.0
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./services/notification-service:/app
      - /app/.venv
    command: sh -c "poetry lock || true && poetry install --no-interaction --no-ansi --no-root && poetry run uvicorn app.main:app --host 0.0.0.0 --port 8085 --reload --reload-dir /app --log-level ${LOG_LEVEL:-info}"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - portfolio-network

  order-orchestrator:
    build:
      context: ./services/order-orchestrator
      dockerfile: Dockerfile
      target: dev
    container_name: portfolio-order-orchestrator
    ports:
      - "${ORDER_ORCHESTRATOR_PORT:-8086}:8086"
      - "${ORDER_ORCHESTRATOR_DEBUG_PORT:-5684}:5678"
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-user}:${POSTGRES_PASSWORD:-password}@postgres:5432/order_db
      REDIS_URL: redis://redis:6379/2
      KAFKA_BOOTSTRAP_SERVERS: redpanda:9092
      KAFKA_TOPIC_ORDERS: ${KAFKA_TOPIC_ORDERS:-order-events}
      KAFKA_ENABLED: ${KAFKA_ENABLED:-true}
      MIN_LOT_SIZE: ${MIN_LOT_SIZE:-1}
      MAX_ORDER_VALUE: ${MAX_ORDER_VALUE:-10000000.0}
      MARGIN_CHECK_ENABLED: ${MARGIN_CHECK_ENABLED:-true}
      SERVICE_NAME: order-orchestrator
      SERVICE_VERSION: 0.1.0
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./services/order-orchestrator:/app
      - /app/.venv
    command: sh -c "poetry lock || true && poetry install --no-interaction --no-ansi --no-root && poetry run uvicorn app.main:app --host 0.0.0.0 --port 8086 --reload --reload-dir /app --log-level ${LOG_LEVEL:-info}"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - portfolio-network

  recommendations-service:
    build:
      context: ./services/recommendations-service
      dockerfile: Dockerfile
      target: dev
    container_name: portfolio-recommendations-service
    ports:
      - "${RECOMMENDATIONS_SERVICE_PORT:-8088}:8088"
      - "${RECOMMENDATIONS_SERVICE_DEBUG_PORT:-5687}:5678"
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-user}:${POSTGRES_PASSWORD:-password}@postgres:5432/recommendations_db
      REDIS_URL: redis://redis:6379/3
      MARKETDATA_SERVICE_URL: http://marketdata-service:8081
      AGGREGATOR_SERVICE_URL: http://aggregator-service:8083
      AGENT_ORCHESTRATOR_URL: http://agent-orchestrator:8084
      SERVICE_NAME: recommendations-service
      SERVICE_VERSION: 0.1.0
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./services/recommendations-service:/app
      - /app/.venv
    command: sh -c "poetry lock || true && poetry install --no-interaction --no-ansi --no-root && poetry run uvicorn app.main:app --host 0.0.0.0 --port 8088 --reload --reload-dir /app --log-level ${LOG_LEVEL:-info}"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      marketdata-service:
        condition: service_healthy
      agent-orchestrator:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - portfolio-network

  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
      target: dev
    container_name: portfolio-api-gateway
    ports:
      - "${API_GATEWAY_PORT:-8000}:8000"
      - "${API_GATEWAY_DEBUG_PORT:-5685}:5678"
    environment:
      AUTH_SERVICE_URL: http://auth-service:8080
      AGGREGATOR_SERVICE_URL: http://aggregator-service:8083
      MARKETDATA_SERVICE_URL: http://marketdata-service:8081
      ANALYTICS_SERVICE_URL: http://analytics-service:8082
      AGENT_ORCHESTRATOR_URL: http://agent-orchestrator:8084
      ORDER_ORCHESTRATOR_URL: http://order-orchestrator:8086
      NOTIFICATION_SERVICE_URL: http://notification-service:8085
      ADMIN_SERVICE_URL: http://admin-service:8087
      RECOMMENDATIONS_SERVICE_URL: http://recommendations-service:8088
      JWT_SECRET: ${JWT_SECRET:-dev-secret-key-change-in-production}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      SERVICE_NAME: api-gateway
      SERVICE_VERSION: 0.1.0
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./services/api-gateway:/app
      - /app/.venv
    command: sh -c "poetry lock || true && poetry install --no-interaction --no-ansi --no-root && poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload --reload-dir /app --log-level ${LOG_LEVEL:-info}"
    depends_on:
      auth-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - portfolio-network

  admin-service:
    build:
      context: ./services/admin-service
      dockerfile: Dockerfile
      target: dev
    container_name: portfolio-admin-service
    ports:
      - "${ADMIN_SERVICE_PORT:-8087}:8087"
      - "${ADMIN_SERVICE_DEBUG_PORT:-5686}:5678"
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-user}:${POSTGRES_PASSWORD:-password}@postgres:5432/admin_db
      SERVICE_NAME: admin-service
      SERVICE_VERSION: 0.1.0
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./services/admin-service:/app
      - /app/.venv
    command: sh -c "poetry lock || true && poetry install --no-interaction --no-ansi --no-root && poetry run uvicorn app.main:app --host 0.0.0.0 --port 8087 --reload --reload-dir /app --log-level ${LOG_LEVEL:-info}"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8087/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - portfolio-network

  # Frontend
  web:
    build:
      context: ./web
      dockerfile: Dockerfile.dev
    container_name: portfolio-web
    ports:
      - "${WEB_PORT:-3000}:3000"
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8000}
      NODE_ENV: development
    volumes:
      - ./web:/app
      - /app/node_modules
      - /app/.next
    command: npm run dev
    depends_on:
      - api-gateway
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - portfolio-network

  # Observability
  prometheus:
    image: prom/prometheus:latest
    container_name: portfolio-prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - portfolio-network

  grafana:
    image: grafana/grafana:latest
    container_name: portfolio-grafana
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    depends_on:
      - prometheus
    networks:
      - portfolio-network

volumes:
  postgres_data:
  redis_data:
  redpanda_data:
  vector_db_data:
  prometheus_data:
  grafana_data:

networks:
  portfolio-network:
    driver: bridge
